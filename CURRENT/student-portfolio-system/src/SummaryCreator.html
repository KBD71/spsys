<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: 'Google Sans', sans-serif;
            padding: 15px;
            background-color: #f8f9fa;
            color: #202124;
        }

        h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1a73e8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .sheet-list {
            border: 1px solid #dadce0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }

        .sheet-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .sheet-item:last-child {
            border-bottom: none;
        }

        .sheet-header-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .sheet-header-row input[type="checkbox"] {
            margin-right: 10px;
        }

        .sheet-name-label {
            font-weight: 500;
        }

        .column-select-row {
            margin-left: 25px;
            /* check box width indent */
            display: none;
            /* hidden by default */
        }

        select {
            width: 100%;
            padding: 5px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            background: white;
        }

        .btn {
            width: 100%;
            padding: 10px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:disabled {
            background-color: #dadce0;
            cursor: not-allowed;
        }

        .loader {
            display: none;
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
            color: #5f6368;
        }
    </style>
</head>

<body>
    <h2>ğŸ“‹ ì¢…í•© ë°ì´í„° ìƒì„±</h2>

    <div class="form-group">
        <label for="summaryTitle">ìƒˆ ì‹œíŠ¸ ì œëª©</label>
        <input type="text" id="summaryTitle" value="ê³¼ì œ ì¢…í•© ë°ì´í„°" placeholder="ì˜ˆ: 1í•™ê¸° ê³¼ì œ ì¢…í•©">
    </div>

    <div class="form-group">
        <label>ê³¼ì œ ë° ì—´ ì„ íƒ</label>
        <div id="sheetListContainer" class="sheet-list">
            <div style="padding:15px; text-align:center; color:#888;">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <button id="generateBtn" class="btn" onclick="generate()">ìƒì„±í•˜ê¸°</button>
    <div id="loader" class="loader">ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>

    <script>
        $(function () {
            // ì´ˆê¸° ë¡œë“œ: ê³¼ì œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            google.script.run.withSuccessHandler(renderSheetList).getAssignmentSheetList();
        });

        // ìºì‹œ ì—­í• : ì‹œíŠ¸ë³„ í—¤ë” ì €ì¥ (sheetName -> headers[])
        const headersCache = {};

        function renderSheetList(sheetNames) {
            const container = $('#sheetListContainer');
            container.empty();

            if (sheetNames.length === 0) {
                container.html('<div style="padding:15px; text-align:center; color:#888;">ê³¼ì œ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                return;
            }

            sheetNames.forEach(name => {
                const item = $(`
            <div class="sheet-item" data-name="${name}">
              <div class="sheet-header-row">
                <input type="checkbox" id="chk_${name}" onchange="toggleSheetSelection('${name}')">
                <label for="chk_${name}" class="sheet-name-label">${name}</label>
              </div>
              <div class="column-select-row" id="col_row_${name}">
                <select id="sel_${name}">
                  <option value="">ì—´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
                </select>
              </div>
            </div>
          `);
                container.append(item);
            });
        }

        function toggleSheetSelection(sheetName) {
            const isChecked = $(document.getElementById(`chk_${sheetName}`)).is(':checked');
            const colRow = $(document.getElementById(`col_row_${sheetName}`));

            if (isChecked) {
                colRow.show();
                loadHeadersIfNeeded(sheetName);
            } else {
                colRow.hide();
            }
        }

        function loadHeadersIfNeeded(sheetName) {
            if (headersCache[sheetName]) {
                populateSelect(sheetName, headersCache[sheetName]);
                return;
            }

            google.script.run.withSuccessHandler(headers => {
                headersCache[sheetName] = headers;
                populateSelect(sheetName, headers);
            }).getSheetHeaders(sheetName);
        }

        function populateSelect(sheetName, headers) {
            const select = $(document.getElementById(`sel_${sheetName}`));
            select.empty();

            if (headers.length === 0) {
                select.append('<option value="">í—¤ë” ì—†ìŒ</option>');
                return;
            }

            // ê¸°ë³¸ ì„ íƒ ì œì•ˆ: "ì¢…í•©ì˜ê²¬"ì´ ìˆìœ¼ë©´ ìë™ ì„ íƒ
            let preSelect = "";

            headers.forEach(h => {
                select.append(`<option value="${h}">${h}</option>`);
                if (h.indexOf("ì¢…í•©ì˜ê²¬") !== -1) preSelect = h;
            });

            if (preSelect) select.val(preSelect);
        }

        function generate() {
            const title = $('#summaryTitle').val().trim();
            if (!title) {
                alert("ì‹œíŠ¸ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const selections = [];
            $('.sheet-item').each(function () {
                const sheetName = $(this).data('name');
                if ($(document.getElementById(`chk_${sheetName}`)).is(':checked')) {
                    const selectedHeader = $(document.getElementById(`sel_${sheetName}`)).val();
                    if (selectedHeader) {
                        selections.push({
                            sheetName: sheetName,
                            header: selectedHeader
                        });
                    }
                }
            });

            if (selections.length === 0) {
                alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ê³¼ì œì™€ ì—´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            $('#generateBtn').prop('disabled', true);
            $('#loader').show();

            google.script.run
                .withSuccessHandler(msg => {
                    alert(msg);
                    $('#generateBtn').prop('disabled', false);
                    $('#loader').hide();
                    google.script.host.close();
                })
                .withFailureHandler(err => {
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                    $('#generateBtn').prop('disabled', false);
                    $('#loader').hide();
                })
                .generateSummarySheet(title, selections);
        }
    </script>
</body>

</html>