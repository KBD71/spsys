<!DOCTYPE html>
<html lang="ko">
<head>
    </head>
<body>
    <section id="menuScreen" class="screen hidden">
      <header><h1>ğŸ“ í•™ìƒ í¬íŠ¸í´ë¦¬ì˜¤</h1></header>
      <main>
        <section>
          <h2>ğŸ§‘â€ğŸ“ í•™ìƒ ì •ë³´</h2>
          <div class="info-card">
            <p><strong>ì´ë¦„:</strong> <span id="studentName"></span></p>
            <p><strong>í•™ë²ˆ:</strong> <span id="studentIdDisplay"></span></p>
          </div>
        </section>
        <section>
          <h2>ğŸ“ ê³¼ì œ ëª©ë¡ (ì œì¶œìš©)</h2>
          <div id="assignmentsList"><div class="loading-message">ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
        </section>
        <section>
          <h2>ğŸ“Š ë‚´ ê¸°ë¡ ë° ì•Œë¦¼ (ì—´ëŒìš©)</h2>
          <div id="recordsGroupList"><div class="loading-message">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
        </section>
        <section>
          <h2>âš™ï¸ ì„¤ì •</h2>
          <button id="changePasswordBtn" class="btn btn-secondary">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
          <button id="logoutBtn" class="btn btn-primary">ë¡œê·¸ì•„ì›ƒ</button>
        </section>
      </main>
    </section>

    <div id="recordsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="recordsModalTitle">ê¸°ë¡ ë³´ê¸°</h3>
            </div>
            <div class="modal-body" id="recordsModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" onclick="hideRecordsModal()" class="btn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <script>
    // ... (API_BASE, ì „ì—­ ë³€ìˆ˜, handleLogin, logout ë“± ë‹¤ë¥¸ í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼) ...

    // â­â­â­ ë°ì´í„° ë¡œë”© ë° í‘œì‹œ ë¡œì§ (ì „ë©´ ìˆ˜ì •) â­â­â­
    function loadAllData() {
        loadAssignments(); // ê³¼ì œ ëª©ë¡ ë¡œë”©
        loadMyRecords();   // ê¸°ë¡ ë° ì•Œë¦¼ ë¡œë”©
    }

    async function loadMyRecords() {
        const groupListEl = document.getElementById('recordsGroupList');
        groupListEl.innerHTML = '<div class="loading-message">ê¸°ë¡ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try {
            const response = await fetch(`${API_BASE}/my-records?studentId=${currentStudentId}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.message);

            // sheetNameê³¼ typeìœ¼ë¡œ ë°ì´í„°ë¥¼ ê·¸ë£¹í™”
            const groupedRecords = (result.records || []).reduce((acc, record) => {
                const key = `${record.sheetName}|${record.type}`;
                if (!acc[key]) {
                    acc[key] = {
                        sheetName: record.sheetName,
                        type: record.type,
                        records: []
                    };
                }
                acc[key].records.push(record);
                return acc;
            }, {});

            displayRecordGroups(Object.values(groupedRecords));

        } catch (error) {
            groupListEl.innerHTML = `<div class="empty-message">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
        }
    }

    function displayRecordGroups(groups) {
        const groupListEl = document.getElementById('recordsGroupList');
        if (!groups || groups.length === 0) {
            groupListEl.innerHTML = '<div class="empty-message">ê³µê°œëœ ê¸°ë¡ì´ë‚˜ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        groupListEl.innerHTML = groups.map((group, index) => {
            const title = group.type === 'comment' ? `ğŸ“Š ${group.sheetName} (êµì‚¬ ì½”ë©˜íŠ¸)` : `ğŸ“¢ ${group.sheetName} (ì•Œë¦¼)`;
            // JSON.stringifyë¥¼ ì‚¬ìš©í•˜ì—¬ ê·¸ë£¹ ë°ì´í„°ë¥¼ onclick ì†ì„±ì— ì•ˆì „í•˜ê²Œ ì „ë‹¬
            const groupData = escapeHTML(JSON.stringify(group));
            return `
                <div class="assignment-card" onclick='showRecordsModal(${groupData})'>
                    <h4>${escapeHTML(title)}</h4>
                    <div class="assignment-meta">
                        <span>ì´ ${group.records.length}ê°œì˜ í•­ëª© ë³´ê¸°</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function showRecordsModal(group) {
        const modal = document.getElementById('recordsModal');
        const titleEl = document.getElementById('recordsModalTitle');
        const bodyEl = document.getElementById('recordsModalBody');
        
        const title = group.type === 'comment' ? `ğŸ“Š ${group.sheetName} (êµì‚¬ ì½”ë©˜íŠ¸)` : `ğŸ“¢ ${group.sheetName} (ì•Œë¦¼)`;
        titleEl.textContent = title;
        
        bodyEl.innerHTML = group.records.map((record, index) => {
            let cardHtml = `
                <div class="record-card ${record.type}">
                    <div class="data-row">
                        <div class="data-label">${escapeHTML(record.label)}:</div>
                        <div class="data-value">${escapeHTML(record.value || '-')}</div>
                    </div>
            `;
            if (record.type === 'comment' && record.question) {
               cardHtml += `
                <div class="feedback-box">
                  <strong>ğŸ’¬ ì§ˆë¬¸:</strong>
                  <p>${escapeHTML(record.question)}</p>
                </div>`;
            }
            if (record.hasSuggestion) {
              const suggestionId = `modal-suggestion-${index}`; 
              cardHtml += `
                <div class="suggestion-box">
                  <strong>ğŸ’¡ ê±´ì˜ì‚¬í•­:</strong>
                  <div>
                    <textarea id="${suggestionId}" class="suggestion-input" rows="3">${escapeHTML(record.suggestion || '')}</textarea>
                    <button class="btn btn-primary" style="width:auto; padding: 8px 16px; margin-top: 8px;"
                      onclick="saveSuggestion('${escapeHTML(record.sheetName)}', '${suggestionId}')">
                      ì €ì¥
                    </button>
                  </div>
                </div>`;
            }
            cardHtml += `</div>`;
            return cardHtml;
        }).join('');

        modal.classList.remove('hidden');
    }

    function hideRecordsModal() {
        document.getElementById('recordsModal').classList.add('hidden');
    }
    
    // ... (ë‚˜ë¨¸ì§€ ìë°”ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ë“¤ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) ...
</script>
</body>
</html>
