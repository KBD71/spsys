<!DOCTYPE html>
<html lang="ko">
<head>
    </head>
<body>
    <section id="menuScreen" class="screen hidden">
      <header><h1>🎓 학생 포트폴리오</h1></header>
      <main>
        <section>
          <h2>🧑‍🎓 학생 정보</h2>
          <div class="info-card">
            <p><strong>이름:</strong> <span id="studentName"></span></p>
            <p><strong>학번:</strong> <span id="studentIdDisplay"></span></p>
          </div>
        </section>
        <section>
          <h2>📝 과제 목록 (제출용)</h2>
          <div id="assignmentsList"><div class="loading-message">과제 목록을 불러오는 중...</div></div>
        </section>
        <section>
          <h2>📊 내 기록 및 알림 (열람용)</h2>
          <div id="recordsGroupList"><div class="loading-message">기록을 불러오는 중...</div></div>
        </section>
        <section>
          <h2>⚙️ 설정</h2>
          <button id="changePasswordBtn" class="btn btn-secondary">🔑 비밀번호 변경</button>
          <button id="logoutBtn" class="btn btn-primary">로그아웃</button>
        </section>
      </main>
    </section>

    <div id="recordsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="recordsModalTitle">기록 보기</h3>
            </div>
            <div class="modal-body" id="recordsModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" onclick="hideRecordsModal()" class="btn">닫기</button>
            </div>
        </div>
    </div>
    
    <script>
    // ... (API_BASE, 전역 변수, handleLogin, logout 등 다른 함수는 이전과 동일) ...

    // ⭐⭐⭐ 데이터 로딩 및 표시 로직 (전면 수정) ⭐⭐⭐
    function loadAllData() {
        loadAssignments(); // 과제 목록 로딩
        loadMyRecords();   // 기록 및 알림 로딩
    }

    async function loadMyRecords() {
        const groupListEl = document.getElementById('recordsGroupList');
        groupListEl.innerHTML = '<div class="loading-message">기록 그룹을 불러오는 중...</div>';
        try {
            const response = await fetch(`${API_BASE}/my-records?studentId=${currentStudentId}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.message);

            // sheetName과 type으로 데이터를 그룹화
            const groupedRecords = (result.records || []).reduce((acc, record) => {
                const key = `${record.sheetName}|${record.type}`;
                if (!acc[key]) {
                    acc[key] = {
                        sheetName: record.sheetName,
                        type: record.type,
                        records: []
                    };
                }
                acc[key].records.push(record);
                return acc;
            }, {});

            displayRecordGroups(Object.values(groupedRecords));

        } catch (error) {
            groupListEl.innerHTML = `<div class="empty-message">기록을 불러오는 데 실패했습니다: ${error.message}</div>`;
        }
    }

    function displayRecordGroups(groups) {
        const groupListEl = document.getElementById('recordsGroupList');
        if (!groups || groups.length === 0) {
            groupListEl.innerHTML = '<div class="empty-message">공개된 기록이나 알림이 없습니다.</div>';
            return;
        }

        groupListEl.innerHTML = groups.map((group, index) => {
            const title = group.type === 'comment' ? `📊 ${group.sheetName} (교사 코멘트)` : `📢 ${group.sheetName} (알림)`;
            // JSON.stringify를 사용하여 그룹 데이터를 onclick 속성에 안전하게 전달
            const groupData = escapeHTML(JSON.stringify(group));
            return `
                <div class="assignment-card" onclick='showRecordsModal(${groupData})'>
                    <h4>${escapeHTML(title)}</h4>
                    <div class="assignment-meta">
                        <span>총 ${group.records.length}개의 항목 보기</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function showRecordsModal(group) {
        const modal = document.getElementById('recordsModal');
        const titleEl = document.getElementById('recordsModalTitle');
        const bodyEl = document.getElementById('recordsModalBody');
        
        const title = group.type === 'comment' ? `📊 ${group.sheetName} (교사 코멘트)` : `📢 ${group.sheetName} (알림)`;
        titleEl.textContent = title;
        
        bodyEl.innerHTML = group.records.map((record, index) => {
            let cardHtml = `
                <div class="record-card ${record.type}">
                    <div class="data-row">
                        <div class="data-label">${escapeHTML(record.label)}:</div>
                        <div class="data-value">${escapeHTML(record.value || '-')}</div>
                    </div>
            `;
            if (record.type === 'comment' && record.question) {
               cardHtml += `
                <div class="feedback-box">
                  <strong>💬 질문:</strong>
                  <p>${escapeHTML(record.question)}</p>
                </div>`;
            }
            if (record.hasSuggestion) {
              const suggestionId = `modal-suggestion-${index}`; 
              cardHtml += `
                <div class="suggestion-box">
                  <strong>💡 건의사항:</strong>
                  <div>
                    <textarea id="${suggestionId}" class="suggestion-input" rows="3">${escapeHTML(record.suggestion || '')}</textarea>
                    <button class="btn btn-primary" style="width:auto; padding: 8px 16px; margin-top: 8px;"
                      onclick="saveSuggestion('${escapeHTML(record.sheetName)}', '${suggestionId}')">
                      저장
                    </button>
                  </div>
                </div>`;
            }
            cardHtml += `</div>`;
            return cardHtml;
        }).join('');

        modal.classList.remove('hidden');
    }

    function hideRecordsModal() {
        document.getElementById('recordsModal').classList.add('hidden');
    }
    
    // ... (나머지 자바스크립트 함수들은 이전과 동일하게 유지) ...
</script>
</body>
</html>
