
        async function loadAssignments() {
            const listEl = document.getElementById('assignmentsList');
            listEl.innerHTML = '<div class="loading-message">ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            try {
                const response = await fetch(`${API_BASE}/assignments?studentId=${currentStudentId}`);
                const result = await response.json();
                if (result.success) {
                    displayAssignments(result.assignments || []);
                } else { listEl.innerHTML = `<div class="empty-message">${result.message}</div>`; }
            } catch (error) { listEl.innerHTML = '<div class="empty-message">ê³¼ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'; }
        }

        function displayAssignments(assignments) {
            const listEl = document.getElementById('assignmentsList');
            if (assignments.length === 0) {
                listEl.innerHTML = '<div class="empty-message">ì§„í–‰ ì¤‘ì¸ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return;
            }
            listEl.innerHTML = assignments.map(assignment => {
                const isSubmitted = assignment.submitted;
                const allowResubmit = assignment.resubmissionAllowed;
                const isLocked = isSubmitted && !allowResubmit;
                const cardClass = isLocked ? 'assignment-card-disabled' : 'assignment-card';
                const badge = isLocked ? '<span class="submission-badge">ì œì¶œì™„ë£Œ</span>' : '';
                const dueDateText = assignment.dueDate || 'ê¸°í•œ ì—†ìŒ';

                return `
                <div class="${cardClass}" data-assignment-id="${escapeHTML(assignment.id)}" data-assignment-name="${escapeHTML(assignment.name)}" data-is-locked="${isLocked}">
                    <h4>${escapeHTML(assignment.name)}${badge}</h4>
                    <div class="assignment-meta"><span>ë§ˆê°: ${dueDateText}</span></div>
                </div>
            `;
            }).join('');

            listEl.querySelectorAll('.assignment-card').forEach(card => {
                const isLocked = card.dataset.isLocked === 'true';
                if (!isLocked) {
                    card.addEventListener('click', () => {
                        showSubmitModal(card.dataset.assignmentId, card.dataset.assignmentName);
                    });
                }
            });
        }

        async function showSubmitModal(assignmentId, assignmentName) {
            const modal = document.getElementById('submitModal');
            const titleEl = document.getElementById('submitModalTitle');
            const questionsContainer = document.getElementById('questionsContainer');
            const form = document.getElementById('assignmentSubmitForm');

            titleEl.textContent = `${assignmentName} ì œì¶œ`;
            questionsContainer.innerHTML = '<div class="loading-message">ê³¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            form.dataset.assignmentId = assignmentId;
            modal.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/assignment-detail?assignmentId=${assignmentId}&studentId=${currentStudentId}`);
                const result = await response.json();

                if (!result.success) {
                    questionsContainer.innerHTML = `<div class="empty-message">${result.message}</div>`;
                    return;
                }

                // ì‹œí—˜ ëª¨ë“œ ì„¤ì • (examModeê°€ trueì¼ ë•Œë§Œ)
                if (result.examMode) {
                    examModeMaxViolations = result.maxViolations || 3;
                    examModeForceFullscreen = result.forceFullscreen || false;
                    examModeAssignmentId = assignmentId;
                    examModeAssignmentName = assignmentName;
                    
                    // ì‹œí—˜ ëª¨ë“œ ê²½ê³  ë° í™œì„±í™”
                    const startExam = confirm(`ì´ ê³¼ì œëŠ” 'ì‹œí—˜ ëª¨ë“œ'ê°€ ì ìš©ë©ë‹ˆë‹¤.\n\n- í™”ë©´ ì´íƒˆ ì‹œ ê²½ê³ ê°€ ë°œìƒí•˜ë©°, ${examModeMaxViolations}íšŒ ìœ„ë°˜ ì‹œ ìë™ ì œì¶œë©ë‹ˆë‹¤.\n- ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ê°€ ê¸ˆì§€ë©ë‹ˆë‹¤.\n${examModeForceFullscreen ? '- ì „ì²´í™”ë©´ì´ ê°•ì œë©ë‹ˆë‹¤.\n' : ''}\nì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                    
                    if (startExam) {
                        enableExamMode();
                    } else {
                        hideSubmitModal();
                        return;
                    }
                }

                // ì§ˆë¬¸ ë Œë”ë§
                questionsContainer.innerHTML = '';
                
                // â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„: examMode ë˜ëŠ” separateSolutionì¼ ê²½ìš° ë¶„ë¦¬ëœ UI ë Œë”ë§ â˜…â˜…â˜…
                const useSplitFields = result.examMode || result.separateSolution;

                result.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-card';
                    
                    let html = `<div class="question-text"><strong>Q${index + 1}.</strong> ${escapeHTML(q.question)}</div>`;
                    
                    if (useSplitFields) {
                        // í’€ì´/ë‹µ ë¶„ë¦¬ ë Œë”ë§
                        html += `
                            <div class="split-fields-container">
                                <div class="field-group">
                                    <label class="field-label">í’€ì´ê³¼ì •</label>
                                    <div class="input-wrapper">
                                        <textarea name="${q.solutionColumn}" id="input-${q.solutionColumn}" class="math-input" placeholder="í’€ì´ê³¼ì •ì„ ì…ë ¥í•˜ì„¸ìš”...">${escapeHTML(q.solution)}</textarea>
                                        <button type="button" class="btn-math-editor" onclick="openMathEditor('input-${q.solutionColumn}')">âˆ‘</button>
                                        <button type="button" class="btn-save-question" id="save-${q.solutionColumn}" onclick="saveQuestion('input-${q.solutionColumn}', '${q.solutionColumn}')">ì„ì‹œì €ì¥</button>
                                        <div class="save-status" id="status-${q.solutionColumn}"></div>
                                    </div>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">ì •ë‹µ</label>
                                    <div class="input-wrapper">
                                        <textarea name="${q.answerColumn}" id="input-${q.answerColumn}" class="math-input short-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”...">${escapeHTML(q.answer)}</textarea>
                                        <button type="button" class="btn-math-editor" onclick="openMathEditor('input-${q.answerColumn}')">âˆ‘</button>
                                        <button type="button" class="btn-save-question" id="save-${q.answerColumn}" onclick="saveQuestion('input-${q.answerColumn}', '${q.answerColumn}')">ì„ì‹œì €ì¥</button>
                                        <div class="save-status" id="status-${q.answerColumn}"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // ê¸°ì¡´ ë‹¨ì¼ í•„ë“œ ë Œë”ë§
                        html += `
                            <div class="input-wrapper">
                                <textarea name="${q.column}" id="input-${q.column}" class="math-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...">${escapeHTML(q.answer)}</textarea>
                                <button type="button" class="btn-math-editor" onclick="openMathEditor('input-${q.column}')">âˆ‘</button>
                                <button type="button" class="btn-save-question" id="save-${q.column}" onclick="saveQuestion('input-${q.column}', '${q.column}')">ì„ì‹œì €ì¥</button>
                                <div class="save-status" id="status-${q.column}"></div>
                            </div>
                        `;
                    }
                    
                    questionDiv.innerHTML = html;
                    questionsContainer.appendChild(questionDiv);

                    // ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë°©ì§€ (ì‹œí—˜ëª¨ë“œì¼ ë•Œë§Œ)
                    if (result.examMode) {
                        const textareas = questionDiv.querySelectorAll('textarea');
                        textareas.forEach(ta => preventCopyPaste(ta));
                    }
                });

            } catch (error) {
                console.error('ê³¼ì œ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
                questionsContainer.innerHTML = '<div class="empty-message">ê³¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        async function loadMyRecords() {
            const recordsEl = document.getElementById('myRecordsList');
            const notificationsEl = document.getElementById('myNotificationsList');
            recordsEl.innerHTML = '<div class="loading-message">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            notificationsEl.innerHTML = '<div class="loading-message">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            try {
                const response = await fetch(`${API_BASE}/my-records?studentId=${currentStudentId}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                const allRecords = result.records || [];
                const comments = allRecords.filter(r => r.type === 'comment');
                const notifications = allRecords.filter(r => r.type === 'notification');
                displayRecordGroups(recordsEl, groupRecords(comments), 'comment');
                displayRecordGroups(notificationsEl, groupRecords(notifications), 'notification');
            } catch (error) {
                recordsEl.innerHTML = `<div class="empty-message">ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}</div>`;
                notificationsEl.innerHTML = `<div class="empty-message">ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        function groupRecords(records) {
            return records.reduce((acc, record) => {
                if (!acc[record.sheetName]) acc[record.sheetName] = [];
                acc[record.sheetName].push(record); return acc;
            }, {});
        }

        function displayRecordGroups(element, groupedRecords, type) {
            const groups = Object.entries(groupedRecords);
            if (groups.length === 0) {
                const message = type === 'comment' ? "ê³µê°œëœ êµì‚¬ ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤." : "ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.";
                element.innerHTML = `<div class="empty-message">${message}</div>`; return;
            }
            element.innerHTML = groups.map(([sheetName, records]) => {
                return `<div class="assignment-card" data-sheet-name="${escapeHTML(sheetName)}" data-record-type="${type}">
                <h4>${escapeHTML(sheetName)}</h4>
                <div class="assignment-meta"><span>ì´ ${records.length}ê°œì˜ í•­ëª© ë³´ê¸°</span></div>
            </div>`;
            }).join('');

            element.querySelectorAll('.assignment-card').forEach((card, index) => {
                card.addEventListener('click', () => {
                    showRecordsModal({
                        sheetName: groups[index][0],
                        records: groups[index][1],
                        type: card.dataset.recordType
                    });
                });
            });
        }

        function typesetMath(element) {
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([element]).catch(err => console.error('MathJax ë Œë”ë§ ì˜¤ë¥˜:', err));
                }
            }, 0);
        }

        function showRecordsModal(group) {
            const modal = document.getElementById('recordsModal');
            const titleEl = document.getElementById('recordsModalTitle');
            const bodyEl = document.getElementById('recordsModalBody');
            const title = group.type === 'comment' ? `ğŸ“Š ${group.sheetName} (êµì‚¬ ì½”ë©˜íŠ¸)` : `ğŸ“¢ ${group.sheetName} (ì•Œë¦¼)`;
            titleEl.textContent = title;

            // ëª¨ë“  record í‘œì‹œ (ê±´ì˜ì‚¬í•­ ì…ë ¥ì°½ ì œì™¸)
            let bodyHtml = group.records.map((record, index) => {
                return `<div class="record-card ${record.type}">
                <div class="data-row">
                    <div class="data-label">${record.label}:</div>
                    <div class="data-value">${record.value || '-'}</div>
                </div>
            </div>`;
            }).join('');

            // ê±´ì˜ì‚¬í•­ ì…ë ¥ì°½ì´ í•„ìš”í•œì§€ í™•ì¸ (records ì¤‘ í•˜ë‚˜ë¼ë„ hasSuggestionì´ trueë©´)
            const needsSuggestion = group.records.some(r => r.hasSuggestion);

            if (needsSuggestion) {
                // ì²« ë²ˆì§¸ recordì˜ suggestion ê°’ì„ ì‚¬ìš© (ëª¨ë‘ ê°™ì€ ì‹œíŠ¸ë‹ˆê¹Œ)
                const existingSuggestion = group.records.find(r => r.suggestion)?.suggestion || '';
                const suggestionId = `modal-suggestion-group`;

                bodyHtml += `<div class="suggestion-box">
                <strong>ğŸ’¡ ê±´ì˜ì‚¬í•­:</strong>
                <div>
                    <textarea id="${suggestionId}" class="suggestion-input" rows="3" placeholder="ì´ ê³¼ì œì— ëŒ€í•œ ê±´ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”...">${escapeHTML(existingSuggestion)}</textarea>
                    <button class="btn btn-primary" style="width:auto; padding: 8px 16px; margin-top: 8px;" data-sheet-name="${escapeHTML(group.sheetName)}" data-suggestion-id="${suggestionId}">ì €ì¥</button>
                </div>
            </div>`;
            }

            bodyEl.innerHTML = bodyHtml;

            // ì €ì¥ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            bodyEl.querySelectorAll('button[data-suggestion-id]').forEach(btn => {
                btn.addEventListener('click', () => {
                    saveSuggestion(btn.dataset.sheetName, btn.dataset.suggestionId);
                });
            });

            modal.classList.remove('hidden');
        }

        // ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜ (Preview ë³´ì´ê¸° + ë Œë”ë§)
        function switchToPreviewMode(textareaId, previewId) {
            const textarea = document.getElementById(textareaId);
            const preview = document.getElementById(previewId);
            const val = textarea.value;

            textarea.classList.remove('edit-mode');
            textarea.classList.add('hidden-mode');
            preview.classList.add('active');

            if (val && val.trim().length > 0) {
                preview.textContent = val;
                preview.classList.remove('empty');
                typesetMath(preview);
            } else {
                preview.textContent = 'ë‹µë³€ì„ ì…ë ¥í•˜ë ¤ë©´ ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”...';
                preview.classList.add('empty');
            }
        }

        function hideSubmitModal() {
            if (examModeActive) {
                examModeListenersActive = false;
                const shouldClose = confirm('ì‹œí—˜ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì •ë§ë¡œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ì˜: ì œì¶œí•˜ì§€ ì•Šê³  ì¢…ë£Œí•˜ë©´ ë‹µì•ˆì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

                if (!shouldClose) {
                    setTimeout(() => {
                        examModeListenersActive = true;
                    }, 500);
                    return;
                }
                disableExamMode();
            }
            document.getElementById('submitModal').classList.add('hidden');
        }

        async function saveQuestion(textareaId, questionColumn) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) {
                console.error('textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', textareaId);
                return;
            }

            const form = document.getElementById('assignmentSubmitForm');
            const assignmentId = form.dataset.assignmentId;
            const answer = textarea.value;

            const saveButtonId = `save-${questionColumn}`;
            const statusId = `status-${questionColumn}`;
            const saveBtn = document.getElementById(saveButtonId);
            const statusEl = document.getElementById(statusId);

            if (!saveBtn) return;

            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            statusEl.classList.remove('show');

            // ì‹œí—˜ëª¨ë“œì¼ ê²½ìš° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¼ì‹œ ì¤‘ì§€
            const wasListenersActive = examModeListenersActive;
            if (examModeActive) {
                examModeListenersActive = false;
            }

            try {
                const response = await fetch(`${API_BASE}/submit-assignment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: currentStudentId,
                        assignmentId: assignmentId,
                        questionColumn: questionColumn,
                        answer: answer,
                        mode: 'single'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    saveBtn.classList.add('saved');
                    saveBtn.textContent = 'âœ“ ì €ì¥ì™„ë£Œ';
                    statusEl.classList.add('show');

                    setTimeout(() => {
                        saveBtn.classList.remove('saved');
                        saveBtn.textContent = originalText;
                        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬í™œì„±í™”
                        if (examModeActive && wasListenersActive) {
                            setTimeout(() => {
                                examModeListenersActive = true;
                            }, 300);
                        }
                    }, 2000);
                } else {
                    // ì‹¤íŒ¨ ì‹œ alert ì „ì— ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™” í™•ì¸
                    if (examModeActive) {
                        examModeListenersActive = false;
                    }
                    alert(`ì €ì¥ ì‹¤íŒ¨: ${result.message}`);
                    // alert ì¢…ë£Œ í›„ ì¬í™œì„±í™”
                    if (examModeActive && wasListenersActive) {
                        setTimeout(() => {
                            examModeListenersActive = true;
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('ì§ˆë¬¸ ì €ì¥ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ì‹œ alert ì „ì— ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™” í™•ì¸
                if (examModeActive) {
                    examModeListenersActive = false;
                }
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                // alert ì¢…ë£Œ í›„ ì¬í™œì„±í™”
                if (examModeActive && wasListenersActive) {
                    setTimeout(() => {
                        examModeListenersActive = true;
                    }, 300);
                }
            } finally {
                saveBtn.disabled = false;
                // ì„±ê³µ ì¼€ì´ìŠ¤ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì—¬ê¸°ì„œ ì¬í™œì„±í™”
                if (examModeActive && wasListenersActive && !saveBtn.classList.contains('saved')) {
                    setTimeout(() => {
                        examModeListenersActive = true;
                    }, 300);
                }
            }
        }

        async function submitAssignment() {
            // ì‹œí—˜ëª¨ë“œì¼ ê²½ìš° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¼ì‹œ ì¤‘ì§€ (ì œì¶œ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ë¬´ì‹œ)
            const wasListenersActive = examModeListenersActive;
            if (examModeActive) {
                examModeListenersActive = false;
            }

            const form = document.getElementById('assignmentSubmitForm');
            const assignmentId = form.dataset.assignmentId;
            const answers = {};
            const questions = [];
            form.querySelectorAll('textarea').forEach(ta => { answers[ta.name] = ta.value; questions.push({ column: ta.name }); });
            const submitBtn = document.querySelector('#submitModal .submit-btn');
            submitBtn.disabled = true; submitBtn.textContent = 'ì œì¶œ ì¤‘...';
            try {
                const response = await fetch(`${API_BASE}/submit-assignment`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ studentId: currentStudentId, assignmentId, answers }) });
                const result = await response.json();
                if (result.success) {
                    clearDraft(assignmentId, currentStudentId, questions);
                    if (examModeActive) {
                        disableExamMode();
                        // alert ì‹¤í–‰ ì „ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™” í™•ì¸
                        examModeListenersActive = false;
                        alert('ê³¼ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‹œí—˜ ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ê³¼ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    hideSubmitModal();
                    loadAssignments();
                } else {
                    // ì‹¤íŒ¨ ì‹œ alert ì „ì— ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”
                    if (examModeActive) {
                        examModeListenersActive = false;
                    }
                    alert(`ì œì¶œ ì‹¤íŒ¨: ${result.message}`);
                    // ì œì¶œ ì‹¤íŒ¨ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬
                    if (examModeActive && wasListenersActive) {
                        setTimeout(() => {
                            examModeListenersActive = true;
                        }, 300);
                    }
                }
            } catch (error) {
                // ì˜¤ë¥˜ ì‹œ alert ì „ì— ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”
                if (examModeActive) {
                    examModeListenersActive = false;
                }
                alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                // ì œì¶œ ì˜¤ë¥˜ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬
                if (examModeActive && wasListenersActive) {
                    setTimeout(() => {
                        examModeListenersActive = true;
                    }, 300);
                }
            } finally { submitBtn.disabled = false; submitBtn.textContent = 'ì œì¶œí•˜ê¸°'; }
        }

        function saveSuggestion(sheetName, textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) {
                console.error('textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', textareaId);
                return;
            }
            const suggestion = textarea.value;
            const saveBtn = textarea.nextElementSibling;
            if (!saveBtn) {
                console.error('ì €ì¥ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true; saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            fetch(`${API_BASE}/my-records`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ studentId: currentStudentId, sheetName, suggestion }) })
                .then(res => res.json()).then(result => {
                    if (result.success) {
                        saveBtn.style.backgroundColor = '#22c55e'; saveBtn.textContent = 'ì €ì¥ë¨';
                        setTimeout(() => { saveBtn.style.backgroundColor = ''; saveBtn.textContent = originalText; saveBtn.disabled = false; }, 3000);
                    } else { alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message); saveBtn.disabled = false; saveBtn.textContent = originalText; }
                }).catch(error => { console.error('ê±´ì˜ì‚¬í•­ ì €ì¥ ì‹¤íŒ¨:', error); alert('ê±´ì˜ì‚¬í•­ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); saveBtn.disabled = false; saveBtn.textContent = originalText; });
        }

        async function handlePasswordChange(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) { showMessage('passwordChangeMessage', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); return; }
            if (newPassword.length < 4) { showMessage('passwordChangeMessage', 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error'); return; }
            const changeBtn = event.target.querySelector('button[type="submit"]');
            changeBtn.disabled = true; changeBtn.textContent = 'ë³€ê²½ ì¤‘...';
            showMessage('passwordChangeMessage', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            try {
                const response = await fetch(`${API_BASE}/change-password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ studentId: currentStudentId, currentPassword, newPassword }) });
                const result = await response.json();
                if (result.success) {
                    showMessage('passwordChangeMessage', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. 3ì´ˆ í›„ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.', 'success');
                    setTimeout(() => {
                        document.getElementById('passwordChangeForm').reset();
                        showMenu();
                    }, 3000);
                } else { showMessage('passwordChangeMessage', result.message, 'error'); changeBtn.disabled = false; changeBtn.textContent = 'ë³€ê²½í•˜ê¸°'; }
            } catch (error) { showMessage('passwordChangeMessage', 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error'); changeBtn.disabled = false; changeBtn.textContent = 'ë³€ê²½í•˜ê¸°'; }
        }

        function showMessage(elementId, message, type) { const el = document.getElementById(elementId); el.textContent = message; el.className = `message show ${type}`; }
        function hideMessage(elementId) { const el = document.getElementById(elementId); el.className = 'message'; }
        function escapeHTML(str) { if (str === null || str === undefined) return ''; return str.toString().replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match])); }

        function saveDraft(assignmentId, studentId, questionColumn, value) {
            try { localStorage.setItem(`draft-${assignmentId}-${studentId}-${questionColumn}`, value); } catch (e) { console.error("ì„ì‹œ ì €ì¥ ì‹¤íŒ¨:", e); }
        }

        function loadDraft(assignmentId, studentId, questionColumn) {
            try { return localStorage.getItem(`draft-${assignmentId}-${studentId}-${questionColumn}`) || ''; } catch (e) { console.error("ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e); return ''; }
        }
        function clearDraft(assignmentId, studentId, questions) {
            try { questions.forEach(q => { localStorage.removeItem(`draft-${assignmentId}-${studentId}-${q.column}`); }); } catch (e) { console.error("ì„ì‹œ ì €ì¥ ì‚­ì œ ì‹¤íŒ¨:", e); }
        }

        function openMathEditor(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) {
                console.error('textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', textareaId);
                return;
            }

            activeTextareaId = textareaId;
            savedCursorPosition = {
                start: textarea.selectionStart,
                end: textarea.selectionEnd
            };

            const modal = document.getElementById('mathModal');
            modal.classList.remove('hidden');

            const paletteContainer = document.getElementById('mathPaletteContainer');
            if (paletteContainer.children.length === 0) {
                populateMathPalette();
            }

            document.getElementById('mathInput').value = '';
            document.getElementById('mathPreview').innerHTML = '<span style="color: #9ca3af;">ìˆ˜ì‹ ë¯¸ë¦¬ë³´ê¸°</span>';
        }

        function closeMathEditor() {
            document.getElementById('mathModal').classList.add('hidden');
            activeTextareaId = null;
            savedCursorPosition = { start: 0, end: 0 };
        }
