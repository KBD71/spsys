
        function populateMathPalette() {
            const mathSymbols = [
                { display: 'xÂ²', code: 'x^2 ', offset: 3 }, { display: 'xâ¿', code: 'x^{}', offset: 2 },
                { display: 'xâ‚™', code: 'x_{}', offset: 2 }, { display: 'âˆša', code: '\\sqrt{} ', offset: 6 },
                { display: 'â¿âˆša', code: '\\sqrt[]{} ', offset: 7 }, { display: 'âˆ‘', code: '\\sum_{k=1}^{n} ', offset: 14 },
                { display: 'âˆ«', code: '\\int_{a}^{b} ', offset: 11 }, { display: 'a/b', code: '\\frac{}{} ', offset: 6 },
                { display: 'Î±', code: '\\alpha ' }, { display: 'Î²', code: '\\beta ' }, { display: 'Ï€', code: '\\pi ' },
                { display: 'Î¸', code: '\\theta ' }, { display: 'âˆ', code: '\\infty ' }, { display: 'â‰ ', code: '\\neq ' },
                { display: 'â‰¤', code: '\\leq ' }, { display: 'â‰¥', code: '\\geq ' }, { display: 'Â±', code: '\\pm ' },
            ];

            const paletteContainer = document.getElementById('mathPaletteContainer');
            paletteContainer.innerHTML = mathSymbols.map(s =>
                `<button type="button" title="${escapeHTML(s.code.trim())}" data-symbol='${escapeHTML(JSON.stringify(s))}'>${s.display}</button>`
            ).join('');

            paletteContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const symbol = JSON.parse(btn.dataset.symbol);
                    insertMathSymbol(symbol);
                });
            });
        }

        function insertMathSymbol(symbol) {
            const textarea = document.getElementById('mathInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const textToInsert = symbol.code;
            const cursorOffset = symbol.offset !== undefined ? symbol.offset : textToInsert.length;

            textarea.value = text.substring(0, start) + textToInsert + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + cursorOffset;
            textarea.focus();
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function updateMathPreview() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                const preview = document.getElementById('mathPreview');
                const latex = document.getElementById('mathInput').value;

                if (latex.trim() === '') {
                    preview.innerHTML = '<span style="color: #9ca3af;">ìˆ˜ì‹ ë¯¸ë¦¬ë³´ê¸°</span>';
                    return;
                }

                preview.innerHTML = `$$${latex}$$`;

                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([preview]).catch(err => {
                        console.error('MathJax ë Œë”ë§ ì˜¤ë¥˜:', err);
                        preview.innerHTML = '<span style="color: #ef4444;">ìˆ˜ì‹ ë Œë”ë§ ì‹¤íŒ¨</span>';
                    });
                } else {
                    preview.innerHTML = '<span style="color: #f59e0b;">MathJax ë¡œë”© ì¤‘...</span>';
                }
            }, 300);
        }

        function confirmMathInput() {
            if (!activeTextareaId) {
                console.error('í™œì„±í™”ëœ textareaê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const mainTextarea = document.getElementById(activeTextareaId);
            if (!mainTextarea) {
                console.error('textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', activeTextareaId);
                closeMathEditor();
                return;
            }

            const latex = document.getElementById('mathInput').value;

            if (latex.trim()) {
                const start = savedCursorPosition.start;
                const end = savedCursorPosition.end;
                const text = mainTextarea.value;
                const textToInsert = ` $${latex.trim()}$ `;

                mainTextarea.value = text.substring(0, start) + textToInsert + text.substring(end);
                mainTextarea.selectionStart = mainTextarea.selectionEnd = start + textToInsert.length;
                mainTextarea.focus();
                mainTextarea.dispatchEvent(new Event('input', { bubbles: true }));
            }

            closeMathEditor();
        }

        // ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë°©ì§€ í•¨ìˆ˜
        function preventCopyPaste(element) {
            // ë¶™ì—¬ë„£ê¸° ë°©ì§€
            element.addEventListener('paste', function (e) {
                e.preventDefault();
                showMessage('submitMessage', 'ë¶™ì—¬ë„£ê¸°ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                setTimeout(() => hideMessage('submitMessage'), 3000);
                return false;
            });

            // ë³µì‚¬ ë°©ì§€
            element.addEventListener('copy', function (e) {
                e.preventDefault();
                return false;
            });

            // ì˜ë¼ë‚´ê¸° ë°©ì§€
            element.addEventListener('cut', function (e) {
                e.preventDefault();
                return false;
            });

            // ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
            element.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                return false;
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë°©ì§€
            element.addEventListener('drop', function (e) {
                e.preventDefault();
                return false;
            });
        }

        // ì‹œí—˜ ëª¨ë“œ í™œì„±í™”
        function enableExamMode() {
            examModeActive = true;
            examModeViolations = 0;
            examModeWarningShown = false;
            examModeListenersActive = true;

            // ì‹œí—˜ ëª¨ë“œ í‘œì‹œ
            updateExamModeIndicator();

            // ì·¨ì†Œ ë²„íŠ¼ ë¹„í™œì„±í™”
            const cancelBtn = document.getElementById('cancelSubmitBtn');
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.style.opacity = '0.5';
                cancelBtn.style.cursor = 'not-allowed';
            }

            // ê°•ì œ ì „ì²´í™”ë©´ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì „ì²´í™”ë©´ ìš”ì²­
            if (examModeForceFullscreen) {
                enterFullscreen();
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('beforeunload', handleBeforeUnload);

            // ê°•ì œ ì „ì²´í™”ë©´ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ì „ì²´í™”ë©´ ì´íƒˆ ê°ì§€
            if (examModeForceFullscreen) {
                document.addEventListener('fullscreenchange', handleFullscreenChange);
            }

            // ë’¤ë¡œê°€ê¸° ë°©ì§€
            history.pushState(null, '', location.href);
            window.addEventListener('popstate', preventBackNavigation);
            
            // í‚¤ë³´ë“œ/ë§ˆìš°ìŠ¤ ì°¨ë‹¨ ì´ë²¤íŠ¸ ì¶”ê°€
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('contextmenu', handleContextMenu);
            window.addEventListener('copy', handleCopyPaste);
            window.addEventListener('paste', handleCopyPaste);
            window.addEventListener('cut', handleCopyPaste);

            // í¬ì»¤ìŠ¤ ê°•ì œ íƒ€ì´ë¨¸ ì‹œì‘
            setInterval(enforceFocus, 1000);

            console.log('ì‹œí—˜ ëª¨ë“œ í™œì„±í™”ë¨ (ìµœëŒ€ ìœ„ë°˜ íšŸìˆ˜:', examModeMaxViolations, 'íšŒ)');
        }

        // ì‹œí—˜ ëª¨ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateExamModeIndicator() {
            const indicator = document.getElementById('examModeIndicator');
            indicator.textContent = `ğŸ”’ ì‹œí—˜ ëª¨ë“œ | ìœ„ë°˜ ${examModeViolations}/${examModeMaxViolations}íšŒ`;
            indicator.classList.add('active');
        }

        // ì‹œí—˜ ëª¨ë“œ ë¹„í™œì„±í™”
        function disableExamMode(autoSubmitted = false) {
            // ìœ„ë°˜ ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë¡œê·¸ ê¸°ë¡
            if (examModeActive && examModeViolations > 0) {
                const details = autoSubmitted
                    ? `ìë™ ì œì¶œë¨ (ì´ ìœ„ë°˜ íšŸìˆ˜: ${examModeViolations}íšŒ, ìµœëŒ€ í—ˆìš©: ${examModeMaxViolations}íšŒ)`
                    : `ì •ìƒ ì œì¶œë¨ (ì´ ìœ„ë°˜ íšŸìˆ˜: ${examModeViolations}íšŒ, ìµœëŒ€ í—ˆìš©: ${examModeMaxViolations}íšŒ)`;
                logExamEvent('ì‹œí—˜ë¡œê·¸', 0, details);
            }

            examModeActive = false;

            // ì‹œí—˜ ëª¨ë“œ í‘œì‹œ ì œê±°
            document.getElementById('examModeIndicator').classList.remove('active');
            document.getElementById('examWarningOverlay').classList.remove('show');

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);
            window.removeEventListener('beforeunload', handleBeforeUnload);
            document.removeEventListener('fullscreenchange', handleFullscreenChange);
            window.removeEventListener('popstate', preventBackNavigation);
            
            // í‚¤ë³´ë“œ/ë§ˆìš°ìŠ¤ ì°¨ë‹¨ ì´ë²¤íŠ¸ ì œê±°
            window.removeEventListener('keydown', handleKeyDown);
            window.removeEventListener('contextmenu', handleContextMenu);
            window.removeEventListener('copy', handleCopyPaste);
            window.removeEventListener('paste', handleCopyPaste);
            window.removeEventListener('cut', handleCopyPaste);

            // ì „ì²´í™”ë©´ í•´ì œ
            exitFullscreen();

            // ì·¨ì†Œ ë²„íŠ¼ í™œì„±í™”
            const cancelBtn = document.getElementById('cancelSubmitBtn');
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '1';
                cancelBtn.style.cursor = 'pointer';
            }

            // ì‹œí—˜ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™”
            examModeAssignmentId = null;
            examModeAssignmentName = null;

            console.log('ì‹œí—˜ ëª¨ë“œ ë¹„í™œì„±í™”ë¨');
        }

        // ì „ì²´í™”ë©´ ì§„ì…
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {
                    console.log('ì „ì²´í™”ë©´ ìš”ì²­ ì‹¤íŒ¨:', err);
                });
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // ì „ì²´í™”ë©´ í•´ì œ
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {
                    console.log('ì „ì²´í™”ë©´ í•´ì œ ì‹¤íŒ¨:', err);
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        // í™”ë©´ ì „í™˜ ê°ì§€
        function handleVisibilityChange() {
            if (!examModeActive || !examModeListenersActive) return;

            if (document.hidden) {
                examModeViolations++;
                updateExamModeIndicator();

                // ìµœëŒ€ ìœ„ë°˜ íšŸìˆ˜ ì²´í¬
                if (examModeViolations >= examModeMaxViolations) {
                    // ìë™ì œì¶œ ì‹¤í–‰
                    autoSubmitExam();
                } else {
                    showExamWarning('ë‹¤ë¥¸ íƒ­ì´ë‚˜ ì°½ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤!');
                }
            }
        }

        // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì•„ì›ƒ ê°ì§€
        function handleWindowBlur() {
            if (!examModeActive || !examModeListenersActive) return;

            // blurëŠ” alertë‚˜ ëª¨ë‹¬ë¡œ ì¸í•´ì„œë„ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ
            // visibilitychangeì™€ ì¤‘ë³µ ì¹´ìš´íŠ¸ë¥¼ í”¼í•˜ê¸° ìœ„í•´
            // document.hidden ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ì¹´ìš´íŠ¸
            if (!document.hidden) {
                examModeViolations++;
                updateExamModeIndicator();

                // ìµœëŒ€ ìœ„ë°˜ íšŸìˆ˜ ì²´í¬
                if (examModeViolations >= examModeMaxViolations) {
                    // ìë™ì œì¶œ ì‹¤í–‰
                    autoSubmitExam();
                } else {
                    showExamWarning('ì‹œí—˜ í™”ë©´ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤!');
                }
            }
        }

        // í˜ì´ì§€ ì´íƒˆ ë°©ì§€
        function handleBeforeUnload(e) {
            if (!examModeActive) return;

            e.preventDefault();
            e.returnValue = 'ì‹œí—˜ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ë§ë¡œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
            return e.returnValue;
        }

        // ì „ì²´í™”ë©´ í•´ì œ ê°ì§€
        function handleFullscreenChange() {
            if (!examModeActive || !examModeListenersActive || !examModeForceFullscreen) return;

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                examModeViolations++;
                updateExamModeIndicator();

                // ìµœëŒ€ ìœ„ë°˜ íšŸìˆ˜ ì²´í¬
                if (examModeViolations >= examModeMaxViolations) {
                    // ìë™ì œì¶œ ì‹¤í–‰
                    autoSubmitExam();
                } else {
                    showExamWarning('ì „ì²´í™”ë©´ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤!');
                    // ë‹¤ì‹œ ì „ì²´í™”ë©´ìœ¼ë¡œ
                    setTimeout(enterFullscreen, 1000);
                }
            }
        }

        // ë’¤ë¡œê°€ê¸° ë°©ì§€
        function preventBackNavigation(e) {
            if (!examModeActive || !examModeListenersActive) return;

            history.pushState(null, '', location.href);
            examModeViolations++;
            updateExamModeIndicator();

            // ìµœëŒ€ ìœ„ë°˜ íšŸìˆ˜ ì²´í¬
            if (examModeViolations >= examModeMaxViolations) {
                // ìë™ì œì¶œ ì‹¤í–‰
                autoSubmitExam();
            } else {
                showExamWarning('ë’¤ë¡œê°€ê¸°ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
        }

        // ê²½ê³  í‘œì‹œ
        function showExamWarning(message) {
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¼ì‹œ ì¤‘ì§€ (ê²½ê³  í‘œì‹œ ì‹œ blur ì´ë²¤íŠ¸ ë°©ì§€)
            examModeListenersActive = false;

            const overlay = document.getElementById('examWarningOverlay');
            const messageEl = document.getElementById('examWarningMessage');
            const countEl = document.getElementById('examViolationCount');

            messageEl.innerHTML = `${message}<br>ë‹¤ì‹œ ì‹œí—˜ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ ì£¼ì„¸ìš”.<br><br><strong style="color: #ffd700;">ìœ„ë°˜ ${examModeViolations}/${examModeMaxViolations}íšŒ</strong>`;
            countEl.textContent = examModeViolations;
            overlay.classList.add('show');

            // 1ì´ˆ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬í™œì„±í™”
            setTimeout(() => {
                examModeListenersActive = true;
            }, 1000);
        }

        // ì‹œí—˜ í™”ë©´ìœ¼ë¡œ ë³µê·€
        function returnToExam() {
            document.getElementById('examWarningOverlay').classList.remove('show');

            if (examModeForceFullscreen) {
                enterFullscreen();
            }

            // í¬ì»¤ìŠ¤ë¥¼ ë‹¤ì‹œ ë¬¸ì„œë¡œ
            window.focus();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬í™œì„±í™”
            setTimeout(() => {
                examModeListenersActive = true;
            }, 500);
        }

        // â˜… ì¶”ê°€: í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì°¨ë‹¨
        function handleKeyDown(e) {
            if (!examModeActive) return;

            // Alt+Tab, Ctrl+W, F11, ESC ë“± ì°¨ë‹¨
            if (e.altKey && e.key === 'Tab') {
                e.preventDefault();
                examModeViolations++;
                showExamWarning('Alt+Tab ì‚¬ìš©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                return false;
            }

            if (e.ctrlKey && (e.key === 'w' || e.key === 'W')) {
                e.preventDefault();
                showExamWarning('ì°½ ë‹«ê¸° ì‹œë„ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                return false;
            }

            if (e.key === 'F11') {
                e.preventDefault();
                return false;
            }

            if (e.key === 'Escape' && document.fullscreenElement) {
                e.preventDefault();
                return false;
            }

            // Windows í‚¤, ê°œë°œìë„êµ¬ ë‹¨ì¶•í‚¤ ì°¨ë‹¨
            if (e.key === 'Meta' || e.metaKey) {
                e.preventDefault();
                return false;
            }

            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) {
                e.preventDefault();
                examModeViolations++;
                showExamWarning('ê°œë°œìë„êµ¬ ì‚¬ìš©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                return false;
            }

            if (e.key === 'F12') {
                e.preventDefault();
                examModeViolations++;
                showExamWarning('ê°œë°œìë„êµ¬ ì‚¬ìš©ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                return false;
            }
        }

        // â˜… ì¶”ê°€: ë§ˆìš°ìŠ¤ ìš°í´ë¦­ ì°¨ë‹¨
        function handleContextMenu(e) {
            if (!examModeActive) return;

            e.preventDefault();
            // ê²½ê³  ì—†ì´ ì¡°ìš©íˆ ì°¨ë‹¨ (ë„ˆë¬´ ë§ì€ ê²½ê³  ë°©ì§€)
            return false;
        }

        // â˜… ì¶”ê°€: ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ì°¨ë‹¨
        function handleCopyPaste(e) {
            if (!examModeActive) return;

            e.preventDefault();
            // ê²½ê³  ì—†ì´ ì¡°ìš©íˆ ì°¨ë‹¨
            return false;
        }

        // â˜… ì¶”ê°€: í¬ì»¤ìŠ¤ ê°•ì œ íšŒë³µ
        function enforceFocus() {
            if (!examModeActive) return;

            if (!document.hasFocus()) {
                window.focus();
            }

            // ì „ì²´í™”ë©´ ì´íƒˆ ì‹œ ë³µêµ¬
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                enterFullscreen();
            }
        }

        // ìë™ ì œì¶œ (ìœ„ë°˜ íšŸìˆ˜ ì´ˆê³¼ ì‹œ)
        async function autoSubmitExam() {
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”í•˜ì—¬ ì¶”ê°€ ìœ„ë°˜ ë°©ì§€
            examModeListenersActive = false;

            // ê²½ê³  ì˜¤ë²„ë ˆì´ ì œê±°
            document.getElementById('examWarningOverlay').classList.remove('show');

            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì´ë¯¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”ë¨)
            alert(`âš ï¸ ê²½ê³ \n\ní™”ë©´ ì´íƒˆì´ ${examModeMaxViolations}íšŒë¥¼ ì´ˆê³¼í•˜ì—¬ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.`);

            // ì œì¶œ ì‹¤í–‰
            try {
                await submitAssignment();
            } catch (error) {
                console.error('ìë™ ì œì¶œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ alert (ì´ë¯¸ ë¦¬ìŠ¤ë„ˆ ë¹„í™œì„±í™”ë¨)
                alert('ìë™ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì œì¶œí•´ì£¼ì„¸ìš”.');
            }

            // ì‹œí—˜ ëª¨ë“œ ë¹„í™œì„±í™” (ìë™ì œì¶œ í”Œë˜ê·¸ ì „ë‹¬)
            disableExamMode(true);
        }

        // ì‹œí—˜ ë¡œê·¸ ê¸°ë¡ (ì„œë²„ì— ë¡œê¹…)
        async function logExamEvent(eventType, duration, details) {
            if (!examModeAssignmentId) {
                console.error('ì‹œí—˜ ê³¼ì œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                await fetch(`${API_BASE}/Exam-log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentId: currentStudentId,
                        assignmentId: examModeAssignmentId,
                        eventType: eventType,
                        duration: duration || 0,
                        details: details || ''
                    })
                });
                console.log(`ğŸ“Š ì‹œí—˜ ë¡œê·¸ ê¸°ë¡: ${eventType} - ${details}`);
            } catch (error) {
                console.error('ì‹œí—˜ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
            }
        }
    </script>
</body>

</html>
